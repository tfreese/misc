<?xml version="1.0" encoding="UTF-8"?>
<beans
    xmlns="http://www.springframework.org/schema/beans"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:beans="http://www.springframework.org/schema/beans"
    xmlns:context="http://www.springframework.org/schema/context"
    xmlns:jdbc="http://www.springframework.org/schema/jdbc"
	xmlns:task="http://www.springframework.org/schema/task"
	xsi:schemaLocation="
        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd
        http://www.springframework.org/schema/jdbc http://www.springframework.org/schema/jdbc/spring-jdbc.xsd
        http://www.springframework.org/schema/task http://www.springframework.org/schema/task/spring-task.xsd
        ">

	<!--context:annotation-config/ -->

	<!-- Zugriff auf ApplicationContext -->
	<!--bean class="de.freese.jsensors.spring.SpringContext" / -->
    
    <!--jdbc:embedded-database id="dataSource" type="HSQL">
        <jdbc:script  location="classpath:schema.sql"/>
        <jdbc:script location="classpath:test-data.sql"/>
    </jdbc:embedded-database-->
    
	<bean id="dataSource" class="com.zaxxer.hikari.HikariDataSource" destroy-method="close">
	   <constructor-arg>
	       <bean class="com.zaxxer.hikari.HikariConfig">
	           <constructor-arg>
	               <props>
	                   <prop key="driverClassName">org.hsqldb.jdbc.JDBCDriver</prop>
	                   <prop key="jdbcUrl">jdbc:hsqldb:file:${jsensors.home}/hsqldb/sensordb;create=true;shutdown=true</prop>
	                   <prop key="username">sa</prop>
	                   <prop key="password">""</prop>
                       <prop key="maximumPoolSize">3</prop>
                       <prop key="minimumIdle">1</prop>
                       <prop key="autoCommit">false</prop>
	               </props>
	           </constructor-arg>
	       </bean>
	   </constructor-arg>
	</bean>        

	<!-- Backends konfigurieren -->
    <bean id="sensorBackendRegistry" class="de.freese.jsensors.spring.config.SensorBackendRegistryFactoryBean">
        <property name="registry">
            <map>
                <entry>
                    <key>
                        <value>diskFreeRootSensor</value>
                    </key>
                    <list>
                        <ref bean="csvBackendDiskFreeRoot" />
                        <ref bean="jdbcBackendDiskFreeRoot" />
                        <bean class="de.freese.jsensors.backend.ConsoleBackend" />
                    </list>
                </entry>
                <entry>
                    <key>
                        <value>DISKUSAGE_ROOT</value>
                    </key>
                    <list>
                        <ref bean="csvBackendOneFileForAll" />
                        <ref bean="jdbcBackendOneTableForAll" />
                        <bean class="de.freese.jsensors.backend.ConsoleBackend" />
                    </list>
                </entry>
                <entry>
                    <key>
                        <value>CPU_USAGE</value>
                    </key>
                    <list>
                        <ref bean="csvBackendOneFileForAll" />
                        <ref bean="jdbcBackendOneTableForAll" />
                        <bean class="de.freese.jsensors.backend.ConsoleBackend" />
                    </list>
                </entry>
                <entry>
                    <key>
                        <value>MEMORY_USAGE</value>
                    </key>
                    <list>
                        <bean class="de.freese.jsensors.backend.ConsoleBackend" />
                    </list>
                </entry>
                <entry>
                    <key>
                        <value>SWAP_USAGE</value>
                    </key>
                    <list>
                        <bean class="de.freese.jsensors.backend.ConsoleBackend" />
                    </list>
                </entry>
                <entry>
                    <key>
                        <value>NETWORK-IN</value>
                    </key>
                    <list>
                        <bean class="de.freese.jsensors.backend.ConsoleBackend" />
                    </list>
                </entry>
                <entry>
                    <key>
                        <value>NETWORK-OUT</value>
                    </key>
                    <list>
                        <bean class="de.freese.jsensors.backend.ConsoleBackend" />
                    </list>
                </entry>
            </map>
	   </property>
    </bean>

    <bean id="disruptorBackend" class="de.freese.jsensors.backend.disruptor.DisruptorBackend" init-method="start" destroy-method="stop">
        <property name="sensorBackendRegistry" ref="sensorBackendRegistry" />
        <property name="parallelism" value="3" />
        <property name="ringBufferSize" value="16" />
    </bean> 
    
	<bean id="csvBackendDiskFreeRoot" class="de.freese.jsensors.backend.file.CSVBackend" init-method="start" destroy-method="stop">
		<property name="path" value="${jsensors.home}/diskFreeRoot.csv" />
        <property name="batchSize" value="5" />
        <property name="exclusive" value="true" />
	</bean>
    <bean id="csvBackendOneFileForAll" class="de.freese.jsensors.backend.file.CSVBackend" init-method="start" destroy-method="stop">
        <property name="path" value="${jsensors.home}/sensors.csv" />
        <property name="batchSize" value="10" />
    </bean>    
	<!--bean id="csvAsyncBackend" class="de.freese.jsensors.backend.async.AsyncBackend" init-method="start" destroy-method="stop">
		<property name="delegate" ref="csvBackendOneFileForAll" />
	</bean>		
	<bean id="csvAsyncBackend" class="de.freese.jsensors.backend.async.ExecutorBackend" init-method="start" destroy-method="stop">
		<property name="delegate" ref="csvBackendOneFileForAll" />
		<property name="executorService" ref="executorService" />
	</bean-->	

	<bean id="jdbcBackendDiskFreeRoot" class="de.freese.jsensors.backend.jdbc.JDBCBackend" init-method="start" destroy-method="stop">
		<property name="dataSource" ref="dataSource" />
        <property name="tableName" value="DISKFREE_ROOT" />
        <property name="batchSize" value="5" />
        <property name="exclusive" value="true" />    
	</bean>
    <bean id="jdbcBackendOneTableForAll" class="de.freese.jsensors.backend.jdbc.JDBCBackend" init-method="start" destroy-method="stop">
        <property name="dataSource" ref="dataSource" />
        <property name="tableName" value="SENSORS" />
        <property name="batchSize" value="5" />        
    </bean>    

	<!-- Sensoren konfigurieren -->
	<!-- http://docs.spring.io/spring/docs/current/spring-framework-reference/htmlsingle/#beans-factory-ctor-arguments-resolution -->
	<!--bean id="diskFreeRootSensor" class="de.freese.jsensors.sensor.disk.DiskFreeSpaceSensor" init-method="start" destroy-method="stop">
        <constructor-arg value="DISKFREE_ROOT" />
		<property name="disk" value="/" />
		<property name="backend" ref="disruptorBackend" />
	</bean-->
    <bean id="diskFreeRootSensor" class="de.freese.jsensors.spring.config.SensorFactoryBean">
        <property name="sensorClazz" value="de.freese.jsensors.sensor.disk.DiskFreeSpaceSensor" />
        <!--property name="name" ref="DISKFREE_ROOT" /-->
        <property name="backend" ref="disruptorBackend" />
        <property name="propertyMap">
            <map>
                <entry key="disk" value="/"/>
	       </map>        
        </property>
    </bean>
        
	<bean id="diskUsageRootSensor" class="de.freese.jsensors.sensor.disk.DiskUsageSensor" init-method="start" destroy-method="stop">
        <constructor-arg value="DISKUSAGE_ROOT" />
		<property name="disk" value="/" />
		<property name="backend" ref="disruptorBackend" />
	</bean>
	<bean id="cpuUsageSensor" class="de.freese.jsensors.sensor.cpu.CpuUsageSensor">
        <constructor-arg index="0" value="CPU_USAGE" />
		<property name="backend" ref="disruptorBackend" />
	</bean>
	<bean id="memoryUsageSensor" class="de.freese.jsensors.sensor.memory.MemoryUsageSensor">
        <constructor-arg index="0" value="MEMORY_USAGE" />
		<property name="backend" ref="disruptorBackend" />
	</bean>
	<bean id="swapUsageSensor" class="de.freese.jsensors.sensor.swap.SwapUsageSensor">
        <constructor-arg index="0" value="SWAP_USAGE" />
		<property name="backend" ref="disruptorBackend" />
	</bean>
	<bean id="netUsageSensor" class="de.freese.jsensors.sensor.network.NetworkUsageSensor" init-method="start" destroy-method="stop">
        <constructor-arg index="0" value="NETWORK" /> 
		<property name="backend" ref="disruptorBackend" />
	</bean>

	<!-- Sensormessung planen -->
	<task:scheduled-tasks scheduler="taskScheduler">
		<!-- Alle 10 Sekunden ausfÃ¼hren -->
		<!--task:scheduled ref="testSensor" method="measure" cron="*/10 * * * * MON-FRI"/ -->

		<!--task:scheduled ref="diskFreeC" method="scan" initial-delay="1000" fixed-delay="5000" />
		<task:scheduled ref="diskUsageC" method="scan" initial-delay="1000" fixed-delay="5000" /-->
		<task:scheduled ref="diskFreeRootSensor" method="scan" initial-delay="1000" fixed-delay="5000" />
		<task:scheduled ref="diskUsageRootSensor" method="scan" initial-delay="1000" fixed-delay="5000" />
		<task:scheduled ref="cpuUsageSensor" method="scan" initial-delay="1000" fixed-delay="5000" />
		<task:scheduled ref="memoryUsageSensor" method="scan" initial-delay="1000" fixed-delay="5000" />
		<task:scheduled ref="swapUsageSensor" method="scan" initial-delay="1000" fixed-delay="5000" />
		<task:scheduled ref="netUsageSensor" method="scan" initial-delay="1000" fixed-delay="5000" />
	</task:scheduled-tasks>

</beans>
